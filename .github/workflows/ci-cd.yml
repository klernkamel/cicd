name: CI/CD

on:
  push:
    branches: ["master"]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: kubsu
          POSTGRES_PASSWORD: kubsu
          POSTGRES_DB: kubsu
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U kubsu -d kubsu"
          --health-interval=3s
          --health-timeout=3s
          --health-retries=30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build test image
        run: docker build --target test -t app-test .

      - name: Run tests in built image
        run: |
          docker run --rm --network host \
            -e DATABASE_URL="postgresql+psycopg://kubsu:kubsu@127.0.0.1:5432/kubsu" \
            app-test

  deploy:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy with podman-compose
        env:
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
          APP_PORT: ${{ secrets.APP_PORT }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          set -e
          mkdir -p "$DEPLOY_DIR"
          cd "$DEPLOY_DIR"

          if [ ! -d .git ]; then
            git clone "$REPO_URL" .
          else
            git pull
          fi

          export APP_PORT="$APP_PORT"
          podman-compose -f docker-compose.prod.yml up -d --build
          podman image prune -f
